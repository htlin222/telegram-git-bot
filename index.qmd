---
title: "Telegram Git Bot å®Œæ•´æ•™å­¸"
subtitle: "å¾ Telegram é ç«¯åŸ·è¡Œ Git æŒ‡ä»¤"
author: "Claude"
date: today
format:
  html:
    toc: true
    toc-depth: 3
    toc-title: "ç›®éŒ„"
    number-sections: true
    code-fold: false
    code-copy: true
    highlight-style: github
    theme: cosmo
---

## ç°¡ä»‹

é€™ä»½æ•™å­¸æœƒå¸¶ä½ å»ºç«‹ä¸€å€‹ Telegram Botï¼Œè®“ä½ å¯ä»¥å¾æ‰‹æ©Ÿæˆ–é›»è…¦é ç«¯åœ¨ä½ çš„æ©Ÿå™¨ä¸ŠåŸ·è¡Œ Git æŒ‡ä»¤ã€‚

### æ¶æ§‹æ¦‚è¦½

```
ä½ åœ¨ Telegram è¼¸å…¥: /git home ~/projects/app pull
                        â†“
              Telegram é›²ç«¯è½‰ç™¼åˆ°ä½ çš„ Bot
                        â†“
         ä½ çš„æ©Ÿå™¨ä¸Šçš„ Bot Agent æ”¶åˆ°æŒ‡ä»¤
                        â†“
         æª¢æŸ¥è³‡æ–™å¤¾å­˜åœ¨ â†’ åŸ·è¡Œ git pull
                        â†“
              å›å‚³çµæœåˆ° Telegram
```

### åŠŸèƒ½ç‰¹è‰²

- âœ… å¾ä»»ä½•åœ°æ–¹é ç«¯åŸ·è¡Œ Git æŒ‡ä»¤
- âœ… æ”¯æ´å¤šå°æ©Ÿå™¨ï¼ˆhomeã€officeï¼‰
- âœ… å®‰å…¨æª¢æŸ¥ï¼ˆè·¯å¾‘é™åˆ¶ã€æŒ‡ä»¤ç™½åå–®ã€ä½¿ç”¨è€…æ¬Šé™ï¼‰
- âœ… è‡ªå‹•æƒæ Git repositories

---

## å»ºç«‹ Telegram Bot

### æ‰¾ BotFather

æ‰“é–‹ Telegram Appï¼Œåœ¨æœå°‹æ¬„è¼¸å…¥ `@BotFather`ï¼Œé–‹å§‹å°è©±ã€‚

### å»ºç«‹æ–° Bot

ç™¼é€ï¼š

```
/newbot
```

BotFather æœƒå•ä½ ï¼š

1. **Bot åç¨±**ï¼ˆé¡¯ç¤ºåç¨±ï¼‰ï¼šä¾‹å¦‚ `My Git Bot`
2. **Bot username**ï¼ˆå¿…é ˆä»¥ bot çµå°¾ï¼‰ï¼šä¾‹å¦‚ `yourname_git_bot`

æˆåŠŸå¾Œæœƒçµ¦ä½ ä¸€å€‹ Tokenï¼Œæ ¼å¼åƒé€™æ¨£ï¼š

```
123456789:ABCdefGHIjklMNOpqrsTUVwxyz
```

::: {.callout-important}
## é‡è¦
è¤‡è£½ä¸¦ä¿å­˜é€™å€‹ Tokenï¼ä¹‹å¾Œæœƒç”¨åˆ°ã€‚
:::

### è¨­å®š Commands é¸å–®

å° `@BotFather` ç™¼é€ï¼š

```
/setcommands
```

é¸æ“‡ä½ çš„ Botï¼Œç„¶å¾Œè²¼ä¸Šï¼š

```
git - åŸ·è¡Œ git æŒ‡ä»¤
status - æŸ¥çœ‹ bot ç‹€æ…‹
help - ä½¿ç”¨èªªæ˜
list - åˆ—å‡ºå…è¨±çš„å°ˆæ¡ˆè³‡æ–™å¤¾
```

### å–å¾—ä½ çš„ User ID

æœå°‹ `@userinfobot`ï¼Œå°å®ƒç™¼é€ä»»ä½•è¨Šæ¯ï¼Œå®ƒæœƒå›å‚³ä½ çš„ User IDï¼š

```
Id: 123456789
```

::: {.callout-note}
è¨˜ä¸‹é€™å€‹ IDï¼Œç”¨ä¾†è¨­å®šèª°å¯ä»¥ä½¿ç”¨ä½ çš„ Botã€‚
:::

### è¨­å®š Bot Logoï¼ˆé¸æ“‡æ€§ï¼‰

å° `@BotFather` ç™¼é€ï¼š

```
/setuserpic
```

é¸æ“‡ä½ çš„ Botï¼Œç„¶å¾Œä¸Šå‚³ä¸€å¼µåœ–ç‰‡ä½œç‚ºé ­åƒã€‚

---

## å®‰è£ uv

`uv` æ˜¯ä¸€å€‹ç¾ä»£åŒ–çš„ Python å¥—ä»¶ç®¡ç†å·¥å…·ï¼Œé€Ÿåº¦å¿«åˆå¥½ç”¨ã€‚

### macOS / Linux

```bash
curl -LsSf https://astral.sh/uv/install.sh | sh
```

### é‡æ–°è¼‰å…¥ Shell

```bash
source ~/.bashrc  # æˆ– ~/.zshrc
```

### ç¢ºèªå®‰è£æˆåŠŸ

```bash
uv --version
```

æ‡‰è©²æœƒçœ‹åˆ°ç‰ˆæœ¬è™Ÿï¼Œä¾‹å¦‚ `uv 0.5.x`ã€‚

---

## å»ºç«‹å°ˆæ¡ˆ

### å»ºç«‹è³‡æ–™å¤¾

```bash
mkdir -p ~/telegram-git-bot
cd ~/telegram-git-bot
```

### åˆå§‹åŒ– uv å°ˆæ¡ˆ

```bash
uv init
```

é€™æœƒå»ºç«‹ä»¥ä¸‹çµæ§‹ï¼š

```
telegram-git-bot/
â”œâ”€â”€ .python-version
â”œâ”€â”€ main.py
â”œâ”€â”€ pyproject.toml
â””â”€â”€ README.md
```

### åŠ å…¥ä¾è³´å¥—ä»¶

```bash
uv add python-telegram-bot python-dotenv
```

---

## å»ºç«‹è¨­å®šæª”

### config.json

```bash
nano config.json
```

è²¼ä¸Šä»¥ä¸‹å…§å®¹ï¼š

```json
{
    "machine_name": "home",
    "allowed_paths": ["~/"],
    "allowed_user_ids": [123456789],
    "allowed_git_commands": [
        "status",
        "pull",
        "push",
        "fetch",
        "add",
        "commit",
        "log",
        "diff",
        "branch",
        "checkout",
        "merge",
        "stash"
    ],
    "command_timeout": 60,
    "max_output_length": 3500
}
```

::: {.callout-warning}
## è¨­å®šèªªæ˜
- `machine_name`: é€™å°æ©Ÿå™¨çš„åç¨±ï¼Œç”¨æ–¼å€åˆ†å¤šå°æ©Ÿå™¨
- `allowed_paths`: å…è¨±æ“ä½œçš„è·¯å¾‘ï¼ˆ`~/` è¡¨ç¤º home ç›®éŒ„ä¸‹çš„æ‰€æœ‰å­è³‡æ–™å¤¾ï¼‰
- `allowed_user_ids`: æŠŠ `123456789` æ›æˆä½ çš„ Telegram User ID
- `allowed_git_commands`: å…è¨±åŸ·è¡Œçš„ git æŒ‡ä»¤
:::

### .env

```bash
nano .env
```

è²¼ä¸Šï¼ˆæ›æˆä½ çš„ Tokenï¼‰ï¼š

```bash
TELEGRAM_BOT_TOKEN=ä½ çš„Bot_Token
```

### .gitignore

```bash
nano .gitignore
```

```
.env
__pycache__/
*.pyc
.venv/
```

---

## å»ºç«‹ Bot ç¨‹å¼

ç·¨è¼¯ `main.py`ï¼š

```bash
nano main.py
```

åˆªé™¤åŸæœ‰å…§å®¹ï¼Œè²¼ä¸Šä»¥ä¸‹å®Œæ•´ç¨‹å¼ç¢¼ï¼š

```python
#!/usr/bin/env python3
"""
Telegram Git Bot Agent
=====================
å¾ Telegram é ç«¯åŸ·è¡Œ Git æŒ‡ä»¤

ä½¿ç”¨æ–¹å¼:
    /git <machine> <path> <command>
    /git home ~/projects/myapp pull
    /git office ~/work/api status
"""

import json
import logging
import os
import re
import subprocess
from dataclasses import dataclass
from pathlib import Path

from dotenv import load_dotenv
from telegram import Update
from telegram.ext import (
    Application,
    CommandHandler,
    ContextTypes,
    MessageHandler,
    filters,
)

# ============================================================
# è¨­å®š
# ============================================================

load_dotenv()

logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    level=logging.INFO,
)
logger = logging.getLogger(__name__)

CONFIG_FILE = Path(__file__).parent / "config.json"


@dataclass
class Config:
    """Bot è¨­å®š"""

    machine_name: str
    allowed_paths: list[Path]
    allowed_user_ids: list[int]
    allowed_git_commands: list[str]
    command_timeout: int
    max_output_length: int

    @classmethod
    def load(cls, path: Path) -> "Config":
        """å¾ JSON æª”è¼‰å…¥è¨­å®š"""
        with open(path) as f:
            data = json.load(f)

        return cls(
            machine_name=data["machine_name"],
            allowed_paths=[Path(p).expanduser().resolve() for p in data["allowed_paths"]],
            allowed_user_ids=data["allowed_user_ids"],
            allowed_git_commands=data["allowed_git_commands"],
            command_timeout=data.get("command_timeout", 60),
            max_output_length=data.get("max_output_length", 3500),
        )


config = Config.load(CONFIG_FILE)


# ============================================================
# å®‰å…¨æª¢æŸ¥
# ============================================================


def is_user_allowed(user_id: int) -> bool:
    """æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦æœ‰æ¬Šé™"""
    if not config.allowed_user_ids:
        return True
    return user_id in config.allowed_user_ids


def is_path_allowed(target_path: Path) -> bool:
    """æª¢æŸ¥è·¯å¾‘æ˜¯å¦åœ¨å…è¨±ç¯„åœå…§ï¼ˆä½†ä¸èƒ½æ˜¯ ~ æœ¬èº«ï¼‰"""
    try:
        resolved = target_path.expanduser().resolve()
        home = Path.home().resolve()

        # ä¸å…è¨±ç›´æ¥æ“ä½œ home ç›®éŒ„æœ¬èº«
        if resolved == home:
            return False

        # å…è¨± home åº•ä¸‹çš„ä»»ä½•å­è³‡æ–™å¤¾
        for allowed in config.allowed_paths:
            if resolved == allowed or allowed in resolved.parents:
                return True
        return False
    except Exception:
        return False


def is_valid_git_command(cmd: str) -> tuple[bool, str]:
    """æª¢æŸ¥æ˜¯å¦ç‚ºå…è¨±çš„ git æŒ‡ä»¤"""
    cmd = cmd.strip()
    if not cmd:
        return False, ""
    first_word = cmd.split()[0]
    return first_word in config.allowed_git_commands, first_word


def is_git_repo(path: Path) -> bool:
    """æª¢æŸ¥æ˜¯å¦ç‚º git repository"""
    git_dir = path / ".git"
    return git_dir.exists() and git_dir.is_dir()


def sanitize_input(text: str) -> str:
    """ç§»é™¤å±éšªå­—å…ƒ"""
    return re.sub(r"[;&|`$(){}\\]", "", text)


def find_git_repos(base_path: Path, max_depth: int = 3) -> list[Path]:
    """éè¿´å°‹æ‰¾ git repositories"""
    repos = []

    def search(path: Path, depth: int):
        if depth > max_depth:
            return
        try:
            if (path / ".git").is_dir():
                repos.append(path)
                return
            for child in path.iterdir():
                if child.is_dir() and not child.name.startswith("."):
                    search(child, depth + 1)
        except PermissionError:
            pass

    search(base_path, 0)
    return sorted(repos)


# ============================================================
# Git åŸ·è¡Œ
# ============================================================


@dataclass
class GitResult:
    """Git æŒ‡ä»¤åŸ·è¡Œçµæœ"""

    success: bool
    output: str
    return_code: int
    error: str | None = None


def execute_git_command(path: Path, git_cmd: str) -> GitResult:
    """åœ¨æŒ‡å®šè·¯å¾‘åŸ·è¡Œ git æŒ‡ä»¤"""
    full_command = f"git {git_cmd}"

    try:
        result = subprocess.run(
            full_command,
            shell=True,
            cwd=str(path),
            capture_output=True,
            text=True,
            timeout=config.command_timeout,
            env={**os.environ, "GIT_TERMINAL_PROMPT": "0"},
        )

        output = result.stdout.strip() or result.stderr.strip() or "(ç„¡è¼¸å‡º)"

        if len(output) > config.max_output_length:
            output = output[: config.max_output_length] + "\n... (å·²æˆªæ–·)"

        return GitResult(
            success=result.returncode == 0,
            output=output,
            return_code=result.returncode,
        )

    except subprocess.TimeoutExpired:
        return GitResult(
            success=False,
            output="",
            return_code=-1,
            error=f"è¶…æ™‚ ({config.command_timeout}ç§’)",
        )
    except Exception as e:
        return GitResult(
            success=False,
            output="",
            return_code=-1,
            error=str(e),
        )


# ============================================================
# Telegram Handlers
# ============================================================


async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """è™•ç† /start"""
    user = update.effective_user
    user_id = user.id

    if not is_user_allowed(user_id):
        await update.message.reply_text(
            f"âŒ æ²’æœ‰æ¬Šé™\n\nä½ çš„ User ID: `{user_id}`",
            parse_mode="Markdown",
        )
        return

    await update.message.reply_text(
        f"ğŸ‘‹ å—¨ {user.first_name}ï¼\n\n"
        f"æˆ‘æ˜¯ `{config.machine_name}` çš„ Git Bot\n\n"
        f"**ä½¿ç”¨æ–¹å¼:**\n"
        f"`/git {config.machine_name} <path> <command>`\n\n"
        f"**ç¯„ä¾‹:**\n"
        f"```\n"
        f"/git {config.machine_name} ~/projects/app status\n"
        f"/git {config.machine_name} ~/projects/app pull\n"
        f"```\n\n"
        f"è¼¸å…¥ /help æŸ¥çœ‹èªªæ˜",
        parse_mode="Markdown",
    )


async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """è™•ç† /help"""
    if not is_user_allowed(update.effective_user.id):
        return

    commands = ", ".join(config.allowed_git_commands)

    await update.message.reply_text(
        f"ğŸ“– **Git Bot ä½¿ç”¨èªªæ˜**\n\n"
        f"**æ ¼å¼:**\n"
        f"`/git <machine> <path> <git_command>`\n\n"
        f"**å…è¨±çš„ git æŒ‡ä»¤:**\n"
        f"`{commands}`\n\n"
        f"**å…¶ä»–æŒ‡ä»¤:**\n"
        f"â€¢ /status - Bot ç‹€æ…‹\n"
        f"â€¢ /list - åˆ—å‡ºå°ˆæ¡ˆ\n\n"
        f"**ç¯„ä¾‹:**\n"
        f"```\n"
        f"/git {config.machine_name} ~/projects/app status\n"
        f"/git {config.machine_name} ~/projects/app pull\n"
        f"/git {config.machine_name} ~/projects/app log -5 --oneline\n"
        f"```",
        parse_mode="Markdown",
    )


async def status_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """è™•ç† /status"""
    user_id = update.effective_user.id

    if not is_user_allowed(user_id):
        await update.message.reply_text(f"âŒ æ²’æœ‰æ¬Šé™ (ID: `{user_id}`)", parse_mode="Markdown")
        return

    paths_list = "\n".join(f"  â€¢ `{p}`" for p in config.allowed_paths)

    await update.message.reply_text(
        f"ğŸ¤– **Git Bot ç‹€æ…‹**\n\n"
        f"**æ©Ÿå™¨:** `{config.machine_name}`\n"
        f"**ç‹€æ…‹:** ğŸŸ¢ é‹è¡Œä¸­\n\n"
        f"**å…è¨±è·¯å¾‘:**\n{paths_list}",
        parse_mode="Markdown",
    )


async def list_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """è™•ç† /list"""
    if not is_user_allowed(update.effective_user.id):
        return

    await update.message.reply_text("ğŸ” æƒæä¸­...")

    all_repos = []
    for base in config.allowed_paths:
        if base.exists():
            repos = find_git_repos(base)
            all_repos.extend(repos)

    if not all_repos:
        await update.message.reply_text(
            f"ğŸ“ æ²’æœ‰æ‰¾åˆ° Git repository\n\n"
            f"å…è¨±çš„è·¯å¾‘:\n"
            + "\n".join(f"  â€¢ `{p}`" for p in config.allowed_paths),
            parse_mode="Markdown",
        )
        return

    repos_text = "\n".join(f"  â€¢ `{r}`" for r in all_repos[:30])
    if len(all_repos) > 30:
        repos_text += f"\n  ... é‚„æœ‰ {len(all_repos) - 30} å€‹"

    await update.message.reply_text(
        f"ğŸ“ **æ‰¾åˆ° {len(all_repos)} å€‹ Git Repo:**\n\n{repos_text}",
        parse_mode="Markdown",
    )


async def git_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """è™•ç† /git"""
    user_id = update.effective_user.id

    if not is_user_allowed(user_id):
        await update.message.reply_text(
            f"âŒ æ²’æœ‰æ¬Šé™\n\nUser ID: `{user_id}`",
            parse_mode="Markdown",
        )
        return

    args = context.args

    if not args or len(args) < 3:
        await update.message.reply_text(
            f"ğŸ“– **ä½¿ç”¨æ–¹å¼:**\n"
            f"`/git <machine> <path> <command>`\n\n"
            f"**ç¯„ä¾‹:**\n"
            f"```\n"
            f"/git {config.machine_name} ~/projects/app pull\n"
            f"/git {config.machine_name} ~/projects/app status\n"
            f"```\n\n"
            f"è¼¸å…¥ /list æŸ¥çœ‹å°ˆæ¡ˆ",
            parse_mode="Markdown",
        )
        return

    machine = args[0]
    path_str = args[1]
    git_cmd = " ".join(args[2:])

    # ä¸æ˜¯é€™å°æ©Ÿå™¨ï¼Œå¿½ç•¥
    if machine.lower() != config.machine_name.lower():
        return

    processing_msg = await update.message.reply_text(
        f"ğŸ”„ `{config.machine_name}` è™•ç†ä¸­...",
        parse_mode="Markdown",
    )

    # æ¸…ç†è¼¸å…¥
    path_str = sanitize_input(path_str)
    git_cmd = sanitize_input(git_cmd)

    # é©—è­‰æŒ‡ä»¤
    is_valid, first_word = is_valid_git_command(git_cmd)
    if not is_valid:
        await processing_msg.edit_text(
            f"âŒ ä¸å…è¨±çš„æŒ‡ä»¤: `{first_word or '(ç©º)'}`\n\n"
            f"å…è¨±: `{', '.join(config.allowed_git_commands)}`",
            parse_mode="Markdown",
        )
        return

    # è§£æè·¯å¾‘
    try:
        target_path = Path(path_str).expanduser().resolve()
    except Exception:
        await processing_msg.edit_text(f"âŒ ç„¡æ•ˆè·¯å¾‘: `{path_str}`", parse_mode="Markdown")
        return

    # æª¢æŸ¥å­˜åœ¨
    if not target_path.exists():
        suggestions = []
        for base in config.allowed_paths:
            if base.exists():
                repos = find_git_repos(base, max_depth=2)
                suggestions.extend(repos[:5])

        suggestion_text = ""
        if suggestions:
            suggestion_text = "\n\n**å¯èƒ½ä½ è¦æ‰¾:**\n" + "\n".join(f"  â€¢ `{s}`" for s in suggestions[:5])

        await processing_msg.edit_text(
            f"âŒ è³‡æ–™å¤¾ä¸å­˜åœ¨: `{target_path}`{suggestion_text}",
            parse_mode="Markdown",
        )
        return

    # æª¢æŸ¥æ˜¯ç›®éŒ„
    if not target_path.is_dir():
        await processing_msg.edit_text(f"âŒ ä¸æ˜¯è³‡æ–™å¤¾: `{target_path}`", parse_mode="Markdown")
        return

    # æª¢æŸ¥å…è¨±ç¯„åœ
    if not is_path_allowed(target_path):
        paths_list = "\n".join(f"  â€¢ `{p}`" for p in config.allowed_paths)
        await processing_msg.edit_text(
            f"âŒ è·¯å¾‘ä¸åœ¨å…è¨±ç¯„åœ: `{target_path}`\n\n**å…è¨±:**\n{paths_list}",
            parse_mode="Markdown",
        )
        return

    # æª¢æŸ¥ git repo
    if not is_git_repo(target_path):
        await processing_msg.edit_text(
            f"âŒ ä¸æ˜¯ Git Repo: `{target_path}`\n\nğŸ’¡ æ²’æœ‰ `.git` ç›®éŒ„",
            parse_mode="Markdown",
        )
        return

    # åŸ·è¡Œ
    logger.info(f"User {user_id}: git {git_cmd} in {target_path}")
    result = execute_git_command(target_path, git_cmd)

    project_name = target_path.name

    if result.error:
        await processing_msg.edit_text(
            f"âŒ **{config.machine_name}** / `{project_name}`\n\néŒ¯èª¤: {result.error}",
            parse_mode="Markdown",
        )
    elif result.success:
        await processing_msg.edit_text(
            f"âœ… **{config.machine_name}** / `{project_name}`\n"
            f"ğŸ“ `git {git_cmd}`\n\n"
            f"```\n{result.output}\n```",
            parse_mode="Markdown",
        )
    else:
        await processing_msg.edit_text(
            f"âš ï¸ **{config.machine_name}** / `{project_name}`\n"
            f"ğŸ“ `git {git_cmd}` (exit: {result.return_code})\n\n"
            f"```\n{result.output}\n```",
            parse_mode="Markdown",
        )


async def unknown_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """æœªçŸ¥æŒ‡ä»¤"""
    if not is_user_allowed(update.effective_user.id):
        return
    await update.message.reply_text("â“ æœªçŸ¥æŒ‡ä»¤ï¼Œè¼¸å…¥ /help æŸ¥çœ‹èªªæ˜")


# ============================================================
# ä¸»ç¨‹å¼
# ============================================================


def main() -> None:
    """å•Ÿå‹• Bot"""
    token = os.getenv("TELEGRAM_BOT_TOKEN")

    if not token:
        logger.error("âŒ TELEGRAM_BOT_TOKEN æœªè¨­å®šï¼")
        logger.error("è«‹åœ¨ .env è¨­å®š: TELEGRAM_BOT_TOKEN=your_token")
        return

    logger.info(f"ğŸš€ Starting Git Bot on [{config.machine_name}]")
    logger.info(f"ğŸ“ Allowed paths: {config.allowed_paths}")
    logger.info(f"ğŸ‘¤ Allowed users: {config.allowed_user_ids}")

    application = Application.builder().token(token).build()

    application.add_handler(CommandHandler("start", start_command))
    application.add_handler(CommandHandler("help", help_command))
    application.add_handler(CommandHandler("status", status_command))
    application.add_handler(CommandHandler("list", list_command))
    application.add_handler(CommandHandler("git", git_command))
    application.add_handler(MessageHandler(filters.COMMAND, unknown_command))

    application.run_polling(allowed_updates=Update.ALL_TYPES)


if __name__ == "__main__":
    main()
```

---

## æ¸¬è©¦åŸ·è¡Œ

### æ‰‹å‹•åŸ·è¡Œ

```bash
cd ~/telegram-git-bot
uv run main.py
```

æ‡‰è©²æœƒçœ‹åˆ°ï¼š

```
2024-xx-xx - INFO - ğŸš€ Starting Git Bot on [home]
2024-xx-xx - INFO - ğŸ“ Allowed paths: [PosixPath('/Users/xxx')]
2024-xx-xx - INFO - ğŸ‘¤ Allowed users: [123456789]
```

### åœ¨ Telegram æ¸¬è©¦

1. æ‰“é–‹ Telegramï¼Œæœå°‹ä½ çš„ Botï¼ˆ`@yourname_git_bot`ï¼‰
2. é»ã€ŒStartã€æˆ–ç™¼é€ `/start`
3. è©¦è©¦é€™äº›æŒ‡ä»¤ï¼š

| æŒ‡ä»¤ | åŠŸèƒ½ |
|------|------|
| `/start` | é–‹å§‹ |
| `/help` | ä½¿ç”¨èªªæ˜ |
| `/status` | Bot ç‹€æ…‹ |
| `/list` | åˆ—å‡ºæ‰€æœ‰ Git å°ˆæ¡ˆ |
| `/git home ~/projects/app status` | åŸ·è¡Œ git status |
| `/git home ~/projects/app pull` | åŸ·è¡Œ git pull |

---

## è¨­å®šé–‹æ©Ÿè‡ªå‹•å•Ÿå‹•ï¼ˆmacOSï¼‰

macOS ä½¿ç”¨ `launchd` å’Œ `plist` æª”æ¡ˆä¾†ç®¡ç†æœå‹™ã€‚

### ç¢ºèª uv è·¯å¾‘

```bash
which uv
```

è¨˜ä¸‹è¼¸å‡ºçš„è·¯å¾‘ï¼Œä¾‹å¦‚ `/opt/homebrew/bin/uv`ã€‚

### å»ºç«‹ plist æª”æ¡ˆ

```bash
nano ~/Library/LaunchAgents/com.telegram-git-bot.plist
```

è²¼ä¸Šä»¥ä¸‹å…§å®¹ï¼ˆ**è¨˜å¾—æŠŠè·¯å¾‘æ›æˆä½ çš„**ï¼‰ï¼š

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.telegram-git-bot</string>

    <key>ProgramArguments</key>
    <array>
        <string>/opt/homebrew/bin/uv</string>
        <string>run</string>
        <string>main.py</string>
    </array>

    <key>WorkingDirectory</key>
    <string>/Users/ä½ çš„ä½¿ç”¨è€…åç¨±/telegram-git-bot</string>

    <key>EnvironmentVariables</key>
    <dict>
        <key>PATH</key>
        <string>/opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin</string>
    </dict>

    <key>RunAtLoad</key>
    <true/>

    <key>KeepAlive</key>
    <true/>

    <key>StandardOutPath</key>
    <string>/Users/ä½ çš„ä½¿ç”¨è€…åç¨±/telegram-git-bot/bot.log</string>

    <key>StandardErrorPath</key>
    <string>/Users/ä½ çš„ä½¿ç”¨è€…åç¨±/telegram-git-bot/bot-error.log</string>
</dict>
</plist>
```

::: {.callout-important}
## é‡è¦
æŠŠ `/opt/homebrew/bin/uv` æ›æˆ `which uv` çš„è¼¸å‡ºï¼ŒæŠŠ `ä½ çš„ä½¿ç”¨è€…åç¨±` æ›æˆ `whoami` çš„è¼¸å‡ºã€‚
:::

### è¼‰å…¥æœå‹™

```bash
launchctl bootstrap gui/$(id -u) ~/Library/LaunchAgents/com.telegram-git-bot.plist
```

### å¸¸ç”¨æŒ‡ä»¤

| å‹•ä½œ | æŒ‡ä»¤ |
|------|------|
| å•Ÿå‹• | `launchctl start com.telegram-git-bot` |
| åœæ­¢ | `launchctl stop com.telegram-git-bot` |
| æŸ¥çœ‹ç‹€æ…‹ | `launchctl list \| grep telegram` |
| å¸è¼‰ | `launchctl bootout gui/$(id -u)/com.telegram-git-bot` |
| çœ‹ log | `tail -f ~/telegram-git-bot/bot.log` |
| çœ‹éŒ¯èª¤ | `tail -f ~/telegram-git-bot/bot-error.log` |

---

## å¤šå°æ©Ÿå™¨è¨­å®š

å¦‚æœä½ æœ‰å¤šå°æ©Ÿå™¨ï¼ˆä¾‹å¦‚ home å’Œ officeï¼‰ï¼Œåœ¨æ¯å°æ©Ÿå™¨ä¸Šï¼š

1. é‡è¤‡ @sec-å»ºç«‹å°ˆæ¡ˆ åˆ° @sec-è¨­å®šé–‹æ©Ÿè‡ªå‹•å•Ÿå‹•macos çš„æ­¥é©Ÿ
2. åªéœ€è¦ä¿®æ”¹ `config.json` çš„ `machine_name`ï¼š

**Home æ©Ÿå™¨ï¼š**
```json
{
    "machine_name": "home",
    ...
}
```

**Office æ©Ÿå™¨ï¼š**
```json
{
    "machine_name": "office",
    ...
}
```

ä½¿ç”¨æ™‚æŒ‡å®šæ©Ÿå™¨åç¨±ï¼š

```
/git home ~/projects/app pull
/git office ~/work/api status
```

---

## ä½¿ç”¨ç¯„ä¾‹

```
/git home ~/projects/myapp status               # æŸ¥çœ‹ç‹€æ…‹
/git home ~/projects/myapp pull                 # æ‹‰å–æœ€æ–°
/git home ~/projects/myapp add .                # åŠ å…¥æ‰€æœ‰è®Šæ›´
/git home ~/projects/myapp commit -m "update"   # æäº¤
/git home ~/projects/myapp push                 # æ¨é€
/git home ~/projects/myapp log -5 --oneline     # çœ‹æœ€è¿‘ 5 ç­† log
/git home ~/projects/myapp branch               # åˆ—å‡ºåˆ†æ”¯
/git home ~/projects/myapp checkout main        # åˆ‡æ›åˆ° main åˆ†æ”¯
```

---

## ç–‘é›£æ’è§£

### Bot æ²’æœ‰å›æ‡‰

1. ç¢ºèª Bot ç¨‹å¼æœ‰åœ¨åŸ·è¡Œ
2. ç¢ºèª Token æ­£ç¢º
3. æª¢æŸ¥ logï¼š`cat ~/telegram-git-bot/bot-error.log`

### æ²’æœ‰æ¬Šé™

ç¢ºèª `config.json` çš„ `allowed_user_ids` æœ‰åŒ…å«ä½ çš„ Telegram User IDã€‚

### æ‰¾ä¸åˆ°è³‡æ–™å¤¾

1. ç”¨ `/list` æŸ¥çœ‹æœ‰å“ªäº›å¯ç”¨çš„å°ˆæ¡ˆ
2. ç¢ºèªè·¯å¾‘æ‹¼å¯«æ­£ç¢º
3. ç¢ºèªè·¯å¾‘åœ¨ `allowed_paths` ç¯„åœå…§

### launchd è¼‰å…¥å¤±æ•—

1. ç¢ºèª plist èªæ³•æ­£ç¢ºï¼š`plutil -lint ~/Library/LaunchAgents/com.telegram-git-bot.plist`
2. ç¢ºèªæ‰€æœ‰è·¯å¾‘éƒ½æ­£ç¢ºï¼ˆuv è·¯å¾‘ã€å°ˆæ¡ˆè·¯å¾‘ã€ä½¿ç”¨è€…åç¨±ï¼‰
3. ç¢ºèªæª”æ¡ˆæ¬Šé™ï¼š`chmod 644 ~/Library/LaunchAgents/com.telegram-git-bot.plist`

---

## å®‰å…¨å»ºè­°

1. **é™åˆ¶ä½¿ç”¨è€…**ï¼šåªå…è¨±ç‰¹å®šçš„ Telegram User ID ä½¿ç”¨
2. **é™åˆ¶è·¯å¾‘**ï¼šä¸è¦é–‹æ”¾æ•´å€‹ `~/`ï¼Œåªé–‹æ”¾éœ€è¦çš„è·¯å¾‘
3. **é™åˆ¶æŒ‡ä»¤**ï¼šç§»é™¤å±éšªçš„ git æŒ‡ä»¤ï¼ˆå¦‚ `reset --hard`ï¼‰
4. **ä¿è­· Token**ï¼šä¸è¦æŠŠ `.env` åŠ å…¥ git

---

## å°ˆæ¡ˆçµæ§‹ç¸½è¦½

```
~/telegram-git-bot/
â”œâ”€â”€ .env                 # Tokenï¼ˆä¸è¦ commitï¼ï¼‰
â”œâ”€â”€ .gitignore           # å¿½ç•¥ .env å’Œå¿«å–
â”œâ”€â”€ .python-version      # Python ç‰ˆæœ¬
â”œâ”€â”€ .venv/               # è™›æ“¬ç’°å¢ƒ
â”œâ”€â”€ bot.log              # åŸ·è¡Œ log
â”œâ”€â”€ bot-error.log        # éŒ¯èª¤ log
â”œâ”€â”€ config.json          # Bot è¨­å®š
â”œâ”€â”€ main.py              # ä¸»ç¨‹å¼
â”œâ”€â”€ pyproject.toml       # uv å°ˆæ¡ˆè¨­å®š
â”œâ”€â”€ README.md            # èªªæ˜æ–‡ä»¶
â””â”€â”€ uv.lock              # ä¾è³´é–å®š
```

---

## å®Œæˆï¼ğŸ‰

ç¾åœ¨ä½ å¯ä»¥å¾ä»»ä½•åœ°æ–¹ï¼Œç”¨ Telegram é ç«¯åŸ·è¡Œ Git æŒ‡ä»¤äº†ï¼

æœ‰å•é¡Œæ­¡è¿å›ä¾†å• ğŸ˜„
